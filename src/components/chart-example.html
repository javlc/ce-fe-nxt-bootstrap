<!DOCTYPE html>
<html lang="en-US" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>CE Vision: Map</title>
        <style>
            #choropleth {
                height: 800px;
                margin: 50px auto;
            }

            #choropleth .highcharts-tooltip caption {
                text-align: left;
                font-size: 1rem;
                font-weight: bold;
                border-bottom: 1px solid #ccc;
                color: #1a7a9f;
            }

            #choropleth .highcharts-tooltip th {
                font-size: 0.8rem;
                font-weight: normal;
            }

            #choropleth .highcharts-tooltip td {
                padding-left: 2rem;
                font-size: 0.8rem;
                text-align: right;
            }
        </style>

        <script src="https://code.highcharts.com/maps/highmaps.js"></script>
        <script src="https://code.highcharts.com/mapdata/countries/us/us-all.js"></script>

        <script>
            window.addEventListener('DOMContentLoaded', () => {

                async function refresh_map(chart, start_date, end_date, share_by, entities) {
                    /* const opts2 = {
                      start_date: '2021-01-6',
                      end_date: '2021-04-30',
                      entities: [
                        {
                        "entity_name": "company 1",
                          "main": [
                            0
                          ],
                          "payment": [
                            0
                          ],
                          "distribution": [
                            0
                          ]
                        },
                        {
                        "entity_name": "company 2",
                          "main": [
                            0
                          ],
                          "payment": [
                            0
                          ],
                          "distribution": [
                            0
                          ]
                        }
                      ],
                      first_purchase_since: 2
                    }
                    const res2 = await fetch('http://104.196.102.188/chart/retention', {
                      method: 'POST',
                      headers: {'Content-Type': 'application/json'},
                      body: JSON.stringify(opts2)
                    });
                    const data2 = await res2.json(); */
                    // const response = await fetch('https://stargate-dev.cei.ventures/chart/market_share/map', {
                    const response = await fetch('http://104.196.102.188/chart/market_share/map', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({start_date: start_date, end_date: end_date, share_by: share_by, entities: entities})
                    });

                    const data = await response.json();
                    console.log('data: ', data);
                    // console.log('retention data: ', data2);
                    const series_data = [];

                    console.log('chart.series[0].mapMap: ', chart.series[0].mapMap)
                    console.log('chart.series[0]: ', chart.series[0])
                    // Iterate over the mapMap key (state two-char codes)
                    for (const state_code in chart.series[0].mapMap) {
                        series_data.push([
                            state_code,                                                                   // state
                            data[entities[0].entity_name][state_code],                                    // value (for color coding)
                            Object.keys(data).map(company => [company, data[company][state_code] || 0])   // tooltip_labels
                        ]);
                    }

                    chart.series[0].setData(series_data);
                }

                const user_choices = {
                    start_date: "2019-01-01",
                    end_date  : "2019-12-31",
                    share_by  : "selected",
                    entities  : [
                        {
                            entity_name: 'IN-N-OUT',
                            main: [11482]
                        },
                        {
                            entity_name: 'SHAKE SHACK',
                            main: [12497]
                        },
                        {
                            entity_name: 'FIVE GUYS',
                            main: [11087]
                        },
                    ]
                };

                const choromap = Highcharts.mapChart('choropleth', {
                    credits  : {enabled: false},
                    title    : {text: undefined},
                    legend   : {
                        layout: 'vertical',
                        align: 'left',
                        verticalAlign: 'top',
                        y: 50,
                        symbolHeight: 600,
                        symbolWidth: 25,
                    },
                    colorAxis: {
                        min: 0,
                        max: 1,
                        type: 'linear',
                        minColor: '#7fdbf4',
                        maxColor: '#0c2c4b',
                        reversed: false,
                        gridLineWidth: 0,
                        labels: {
                            formatter: function () {
                                return (100 * this.value) + '%';
                            }
                        }
                    },
                    series: [{
                        mapData: Highcharts.maps['countries/us/us-all'],
                        name: 'State',
                        keys: ['state', 'value', 'tooltip_labels'],
                        joinBy: ['hc-a2', 'state'],
                        borderColor: '#ffffff',
                        borderWidth: 3,
                    }],
                    tooltip: {
                        headerFormat: '',
                        useHTML: true,
                        pointFormatter: function() {
                            // sort by market share then format the text
                            return '<table><caption>' + this.name + '</caption>'
                            + this.tooltip_labels
                            .sort((a, b) => {
                                return b[1] - a[1];
                            })
                            .map(i => '<tr><th>' + i[0] + '</th><td>' + Math.round(100 * i[1]) + '%</td></tr>')
                            .join('')
                            + '</table>'
                        }
                    }
                });

                refresh_map(choromap, user_choices.start_date, user_choices.end_date, user_choices.share_by, user_choices.entities);
            });
        </script>
    </head>
    <body>
        <div id="choropleth"></div>
    </body>
</html>
